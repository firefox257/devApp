<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>CSG Editor - Mobile</title>
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                font-family: 'Segoe UI', sans-serif;
                background: #1e1e1e;
                color: white;
            }
            canvas {
                /* Standard property */
                user-select: none;

                /* Vendor prefixes for broader browser compatibility */
                -webkit-user-select: none; /* Safari/Chrome */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
            }

            #toolbar {
                display: flex;
                background: #2c3e50;
                color: white;
                padding: 0;
                gap: 0;
                justify-content: center;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                z-index: 10;
                position: relative;
            }

            #toolbar button {
                background: #3498db;
                color: white;
                border: none;
                font-size: 1em;
                width: 35px;
                height: 35px;
                cursor: pointer;
                transition: background 0.2s, transform 0.1s;
                box-shadow: none;
                border-radius: 0;
            }

            #toolbar button:active {
                transform: scale(0.95);
            }

            #toolbar button:hover {
                background: #2980b9;
            }

            .toolbar-separator {
                width: 1px;
                background-color: #446688;
                height: 35px;
            }

            #main-container {
                width: 100%;
                height: calc(100vh - 30mm);
                position: relative;
            }

            #code-panel,
            #view-panel,
            #settings-panel,
            #editor-code-panel,
            #help-panel {
                position: absolute;
                width: 100vw;
                height: 100%;
                display: none;
                background: white;
            }

            #csg-code,
            #editor-code {
            }

            #code-panel,
            #editor-code-panel,
            #help-panel {
                background: #1e1e1e;
                color: #f8f8f8;
            }

            #settings-panel {
                background: #282c34;
                color: #f8f8f8;
                padding: 20px;
                box-sizing: border-box;
                overflow-y: auto;
            }

            #settings-panel h2 {
                color: #61afef;
                border-bottom: 2px solid #545862;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            #settings-panel label {
                font-size: 1em;
                color: #a0a0a0;
                margin-bottom: 5px;
            }

            #settings-panel input[type='number'],
            #settings-panel input[type='text'] {
                width: 80px;
                padding: 5px;
                background: #3e4451;
                border: 1px solid #545862;
                color: #f8f8f8;
                border-radius: 4px;
                margin-left: 10px;
            }

            #save-settings-btn {
                background: #28a745;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 20px;
            }

            #save-settings-btn:hover {
                background: #218838;
            }

            #clear-cache-btn {
                background: #dc3545;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 20px;
            }

            #clear-cache-btn:hover {
                background: #c82333;
            }

            #three-canvas {
                width: 100%;
                height: 100%;
                display: block;
            }

            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            }

            .modal-content {
                background: #282c34;
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
            }

            /* ---------- Console panel styles ---------- */
            /* Console container is fixed to bottom so it overlays the 3D area
               and other panels. It is resizable via the bar at its top. */
            #console-container {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                height: 180px; /* default height */
                display: flex;
                flex-direction: column;
                background: #0b0b0b;
                color: #e6e6e6;
                font-family: monospace;
                font-size: 12px;
                z-index: 0;
                border-top: 1px solid #333;
            }

            #console-resizer {
                height: 6px;
                cursor: ns-resize;
                background: linear-gradient(180deg, #222, #111);
                border-top: 1px solid #2b2b2b;
            }

            #console-panel {
                flex: 1;
                overflow-y: auto;
                padding: 8px;
                white-space: pre-wrap;
            }

            .console-log {
                color: #9fffb3;
                margin-bottom: 2px;
            }

            .console-warn {
                color: #ffd966;
                margin-bottom: 2px;
            }

            .console-error {
                color: #ff8b8b;
                margin-bottom: 2px;
            }

            .console-stack {
                color: #a0a0a0; /* Slightly different color for stack trace */
                font-size: 0.9em;
                margin-top: 4px;
                white-space: pre-wrap;
            }
            /* ---------- End console styles ---------- */
        </style>
        <script src="./js/opentype.js"></script>
        <script>
            globalThis.opentype = opentype
        </script>
        <script type="importmap">
            {
                "imports": {
                    "three": "./build/three.module.js",
                    "three/addons/": "./jsm/",
                    "three-mesh-bvh": "./js/mesh-bvh.js",
                    "three-bvh-csg": "./js/csg-bvh.js",
                    "apiCalls": "/js/apiCalls.js"
                }
            }
        </script>
    </head>
    <body>
        <div id="toolbar">
            <button id="btn-3d" title="3D View">&#x1F5BC;</button>
            <div class="toolbar-separator"></div>
            <button
                id="btn-wireframe"
                title="Toggle Wireframe"
                style="display: none">
                &#x1F4CB;
            </button>
            <div
                class="toolbar-separator"
                id="separator-wireframe"
                style="display: none"></div>
            <button id="btn-code" title="CSG Code Editor">&#x1F4BB;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-editor-code" title="Editor Code">&#x2B9D;</button>
            <div class="toolbar-separator"></div>
            <button
                id="btn-clear-cache-by-name"
                style="display: none"
                title="Clear Current Cache">
                &#x2716;
            </button>
            <div
                class="toolbar-separator"
                id="separator-clear-cache"
                style="display: none"></div>
            <button id="btn-settings" title="Settings">&#x2699;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-load" title="Load Project">&#x1F4E5;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-save" title="Save Project">&#x1F4BE;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-help" title="Help">&#x2753;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-clear-console" title="Clear Console">
                &#x1F5D1;
            </button>
        </div>

        <div id="main-container">
            <div id="code-panel">
                <textcode
                    id="csg-code"
                    title="CSG Script"
                    onrun="runCSGCode();">
                </textcode>
            </div>

            <div id="editor-code-panel">
                <textcode
                    id="editor-code"
                    title="Editor Script"
                    onrun="runEditorScript();">
                    // Place reusable functions and objects here. // Access from
                    CSG Script with include("page name"); /* var constants = {
                    PI: Math.PI, E: Math.E }; return { constants }; */
                </textcode>
            </div>

            <div id="view-panel">
                <canvas id="three-canvas"></canvas>
            </div>

            <div id="settings-panel">
                <h2>Settings</h2>
                <label for="width-input">Grid Width:</label>
                <input type="number" id="width-input" value="220" />
                mm<br /><br />
                <label for="length-input">Grid Length:</label>
                <input type="number" id="length-input" value="220" />
                mm<br /><br />
                <label for="grid-size-input">Grid Spacing:</label>
                <input type="number" id="grid-size-input" value="10" />
                mm<br /><br />
                <label for="library-path-input">Library Path:</label>
                <input
                    type="text"
                    id="library-path-input"
                    value="/csgLib" /><br /><br />
					
				



				
				<hr>
				<h3>Export Settings</h3>
				<label>Default Export Format:</label><br />
				<input type="radio" id="format-stl" name="export-format" value="stl" checked>
				<label for="format-stl">STL (.stl)</label><br />
				<input type="radio" id="format-glb" name="export-format" value="glb">
				<label for="format-glb">GLB (.glb)</label>
				<br /><br />

				
					
					
					
				
                <button id="save-settings-btn">Save Settings</button>
                <button id="clear-cache-btn">Clear All Cache</button>
            </div>

            <div
                id="help-panel"
                style="
                    display: none;
                    width: 100vw;
                    height: 100%;
                    background: #282c34;
                    color: white;
                    padding: 20px;
                    box-sizing: border-box;
                    overflow-y: auto;
                ">
                <iframe
                    src="help.html"
                    style="width: 100%; height: 100%; border: none"></iframe>
            </div>
        </div>

        <div id="load-code-modal" class="modal-overlay">
            <div class="modal-content">
                <filepicker
                    id="load-picker"
                    useFileButtonText="Load Code"
                    onfilepick="handleLoadFile(event, filePath)"
                    oncancel="closeModal('load-code-modal')">
                </filepicker>
            </div>
        </div>

        <div id="save-code-modal" class="modal-overlay">
            <div class="modal-content">
                <filepicker
                    id="save-picker"
                    useFileButtonText="Save Code"
                    onfilepick="handleSaveFile(event, filePath)"
                    oncancel="closeModal('save-code-modal')">
                </filepicker>
            </div>
        </div>

        <div id="save-stl-modal" class="modal-overlay">
            <div class="modal-content">
                <filepicker
                    id="save-stl-picker"
                    useFileButtonText="Export 3d"
                    onfilepick="handleSaveStl(event, filePath)"
                    oncancel="closeModal('save-stl-modal')">
                </filepicker>
            </div>
        </div>

        <div id="console-container" aria-live="polite">
            <div id="console-resizer" title="Drag to resize console"></div>
            <div id="console-panel"></div>
        </div>
        <script type="module" src="/ux/textCode.js"></script>
        <script type="module" src="/ux/filePicker.js"></script>

        <script type="module">
            import * as THREE from 'three'
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js'

            import {
                initialize,
                //openModal,
                //closeModal,
                runCSGCode,
                runEditorScript,
                handleLoadFile,
                handleSaveFile,
                handleSaveStl,
                exportSTL,
                clearAllCache,
                clearCurrentCacheByName,
                toggleWireframe
            } from './js/editorCsg.js'

            globalThis.settings = {}
            let currentObjects
            var domElements
            var renderer
            var scene
			var groupItems
            var camera
            var controls
            var keyLight
            var ambientLight
            var originLine
            var buildPlateGrid = null
            var buildPlateBox = null

            // Make these functions available globally for the HTML event handlers
            window.openModal = openModal
            window.closeModal = closeModal
            window.runCSGCode = runCSGCode
            window.runEditorScript = runEditorScript
            window.handleLoadFile = handleLoadFile
            window.handleSaveFile = handleSaveFile
            window.handleSaveStl = handleSaveStl
            window.clearCurrentCacheByName = clearCurrentCacheByName

            function openModal(id) {
                document.getElementById(id).style.display = 'flex'
            }

            function closeModal(id) {
                document.getElementById(id).style.display = 'none'
            }

            // --- Three.js Setup Functions ---

            function setupThreeJs(canvas) {
                renderer = new THREE.WebGLRenderer({
                    canvas,
                    antialias: true
                })
                renderer.setClearColor(0x1e1e1e)
                renderer.setPixelRatio(window.devicePixelRatio)

                scene = new THREE.Scene()
				groupItems = new THREE.Group();
				groupItems. rotation.x=-Math.PI/2;
				scene.add(groupItems)
                camera = new THREE.PerspectiveCamera(
                    60,
                    window.innerWidth / window.innerHeight,
                    0.01,
                    2000
                )

                camera.position.set(0, 50, 50)
                camera.lookAt(0, 0, 0)

                controls = new OrbitControls(camera, canvas);
                controls.enableDamping = true;
                controls.dampingFactor = 0.1;
				controls.minDistance = 0.1;
				controls.rotateSpeed=0.3

                

                keyLight = new THREE.PointLight(0xffffff, 7, 1000, 0.2)
                ambientLight = new THREE.AmbientLight(0xffcc66, 0.5)
                scene.add(keyLight, ambientLight)

                const originLineMaterial = new THREE.LineBasicMaterial({
                    color: 0x555555
                })
                const originLineGeometry =
                    new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, -100, 0),
                        new THREE.Vector3(0, 500, 0)
                    ])
                originLine = new THREE.LineSegments(
                    originLineGeometry,
                    originLineMaterial
                )
                scene.add(originLine)
            }

            function createBuildPlate() {
                if (buildPlateGrid) {
                    scene.remove(buildPlateGrid)
                    buildPlateGrid.geometry.dispose()
                    buildPlateGrid = null
                }
                if (buildPlateBox) {
                    scene.remove(buildPlateBox)
                    buildPlateBox.geometry.dispose()
                    buildPlateBox = null
                }

                const plateSize = Math.max(
                    settings.plateWidth,
                    settings.plateLength
                )
                const divisions = Math.floor(plateSize / settings.gridSize)
                buildPlateGrid = new THREE.GridHelper(
                    plateSize,
                    divisions,
                    0x555555,
                    0x555555
                )
                buildPlateGrid.position.y = 0
                scene.add(buildPlateGrid)

                const boxMaterial = new THREE.LineBasicMaterial({
                    color: 0xcccccc
                })
                const boxGeometry = new THREE.BufferGeometry()
                const halfWidth = settings.plateWidth / 2
                const halfLength = settings.plateLength / 2
                const boxVertices = new Float32Array([
                    -halfWidth,
                    0,
                    -halfLength,
                    halfWidth,
                    0,
                    -halfLength,
                    halfWidth,
                    0,
                    halfLength,
                    halfWidth,
                    0,
                    halfLength,
                    -halfWidth,
                    0,
                    halfLength,
                    -halfWidth,
                    0,
                    -halfLength
                ])
                boxGeometry.setAttribute(
                    'position',
                    new THREE.BufferAttribute(boxVertices, 3)
                )
                buildPlateBox = new THREE.LineSegments(boxGeometry, boxMaterial)
                scene.add(buildPlateBox)
            }

            function resizeRenderer() {
                const canvas = renderer.domElement
                const width = canvas.clientWidth
                const height = canvas.clientHeight

                if (canvas.width !== width || canvas.height !== height) {
                    renderer.setSize(width, height, false)
                    camera.aspect = width / height
                    camera.updateProjectionMatrix()
                }
            }

            function animate() {
                requestAnimationFrame(animate)
                controls.update()
                const cameraDirection = new THREE.Vector3()
                camera.getWorldDirection(cameraDirection)
                keyLight.position
                    .copy(camera.position)
                    .add(cameraDirection.multiplyScalar(-10))
                renderer.render(scene, camera)
            }

            // --- UI Management and File Handling ---
            function showView(id) {
                const dom = {
                    codePanel: document.getElementById('code-panel'),
                    viewPanel: document.getElementById('view-panel'),
                    settingsPanel: document.getElementById('settings-panel'),
                    editorCodePanel:
                        document.getElementById('editor-code-panel'),
                    helpPanel: document.getElementById('help-panel'),
                    btn3D: document.getElementById('btn-3d'),
                    btnCode: document.getElementById('btn-code'),
                    btnEditorCode: document.getElementById('btn-editor-code'),
                    btnSettings: document.getElementById('btn-settings'),
                    btnHelp: document.getElementById('btn-help'),
                    btnClearCacheByName: document.getElementById(
                        'btn-clear-cache-by-name'
                    ),
                    separatorClearCache: document.getElementById(
                        'separator-clear-cache'
                    ),
                    btnWireframe: document.getElementById('btn-wireframe'),
                    separatorWireframe: document.getElementById(
                        'separator-wireframe'
                    )
                }

                dom.codePanel.style.display = 'none'
                dom.viewPanel.style.display = 'none'
                dom.settingsPanel.style.display = 'none'
                dom.editorCodePanel.style.display = 'none'
                dom.helpPanel.style.display = 'none'

                dom.btn3D.style.backgroundColor = '#3498db'
                dom.btnCode.style.backgroundColor = '#3498db'
                dom.btnEditorCode.style.backgroundColor = '#3498db'
                dom.btnSettings.style.backgroundColor = '#3498db'
                dom.btnHelp.style.backgroundColor = '#3498db'

                // Hide the new buttons and separators by default
                dom.btnClearCacheByName.style.display = 'none'
                dom.separatorClearCache.style.display = 'none'
                dom.btnWireframe.style.display = 'none'
                dom.separatorWireframe.style.display = 'none'

                if (id === '3d') {
                    dom.viewPanel.style.display = 'block'
                    dom.btn3D.style.backgroundColor = '#e74c3c'
                    dom.btnWireframe.style.display = 'block'
                    dom.separatorWireframe.style.display = 'block'
                } else if (id === 'code') {
                    dom.codePanel.style.display = 'block'
                    dom.btnCode.style.backgroundColor = '#e74c3c'
                    // Show the new button for code view
                    dom.btnClearCacheByName.style.display = 'block'
                    dom.separatorClearCache.style.display = 'block'
                } else if (id === 'editor-code') {
                    dom.editorCodePanel.style.display = 'block'
                    dom.btnEditorCode.style.backgroundColor = '#e74c3c'
                    // Show the new button for editor code view
                    dom.btnClearCacheByName.style.display = 'block'
                    dom.separatorClearCache.style.display = 'block'
                } else if (id === 'settings') {
                    dom.settingsPanel.style.display = 'block'
                    dom.btnSettings.style.backgroundColor = '#e74c3c'
                } else if (id === 'help') {
                    dom.helpPanel.style.display = 'block'
                    dom.btnHelp.style.backgroundColor = '#e74c3c'
                }
            }

            function saveSettings(domElements) {
                const newWidth = parseFloat(domElements.widthInput.value)
                const newLength = parseFloat(domElements.lengthInput.value)
                const newGridSize = parseFloat(domElements.gridSizeInput.value)
                const newLibraryPath = domElements.libraryPathInput.value

                if (
                    isNaN(newWidth) ||
                    newWidth <= 0 ||
                    isNaN(newLength) ||
                    newLength <= 0 ||
                    isNaN(newGridSize) ||
                    newGridSize <= 0
                ) {
                    alert(
                        'Please enter valid positive numbers for all settings.'
                    )
                    return
                }

                settings.plateWidth = newWidth
                settings.plateLength = newLength
                settings.gridSize = newGridSize
                settings.libraryPath = newLibraryPath
				settings.exportFormat = domElements.exportStlRadio.checked ? 'stl' : 'glb';


                localStorage.setItem(
                    'csg-editor-settings',
                    JSON.stringify(settings)
                )

                createBuildPlate()
                alert('Settings saved successfully!')
            }

            window.onload = function () {
                // Collect all the DOM elements and pass them to the initializer function
                domElements = {
                    btn3D: document.getElementById('btn-3d'),
                    btnCode: document.getElementById('btn-code'),
                    btnEditorCode: document.getElementById('btn-editor-code'),
                    btnSettings: document.getElementById('btn-settings'),
                    btnLoad: document.getElementById('btn-load'),
                    btnSave: document.getElementById('btn-save'),
                    btnHelp: document.getElementById('btn-help'),
                    clearConsoleBtn:
                        document.getElementById('btn-clear-console'),
                    btnWireframe: document.getElementById('btn-wireframe'),
                    widthInput: document.getElementById('width-input'),
                    lengthInput: document.getElementById('length-input'),
                    gridSizeInput: document.getElementById('grid-size-input'),
                    libraryPathInput:
                        document.getElementById('library-path-input'),
                    saveSettingsBtn:
                        document.getElementById('save-settings-btn'),
                    clearCacheBtn: document.getElementById('clear-cache-btn'),
                    csgEditor: document.getElementById('csg-code'),
                    editorCodeEditor: document.getElementById('editor-code'),
                    codePanel: document.getElementById('code-panel'),
                    editorCodePanel:
                        document.getElementById('editor-code-panel'),
                    viewPanel: document.getElementById('view-panel'),
                    settingsPanel: document.getElementById('settings-panel'),
                    helpPanel: document.getElementById('help-panel'),
                    canvas: document.getElementById('three-canvas'),
                    openModal: openModal,
                    closeModal: closeModal,
                    setupThreeJs: setupThreeJs,
                    createBuildPlate: createBuildPlate,
                    resizeRenderer: resizeRenderer,
                    animate: animate,
                    get scene() {
                        return scene
                    },
					get groupItems() {
						return groupItems
					},
                    showView: showView,
					exportStlRadio:document.getElementById('format-stl'),
					exportGlbRadio:document.getElementById('format-glb')
                }
				
				

                // Initial settings load

                settings = {
                    plateWidth: 220,
                    plateLength: 220,
                    gridSize: 10,
                    libraryPath: '/csgLib',
					exportFormat:'stl'
                }
                const savedSettings = localStorage.getItem(
                    'csg-editor-settings'
                )
                if (savedSettings) {
                    settings = JSON.parse(savedSettings)
                }
                domElements.widthInput.value = settings.plateWidth
                domElements.lengthInput.value = settings.plateLength
                domElements.gridSizeInput.value = settings.gridSize
                domElements.libraryPathInput.value = settings.libraryPath
                
				
				if (settings.exportFormat === 'stl') {
					domElements.exportStlRadio.checked = true;
				} else {
				   	domElements.exportGlbRadio.checked = true;
				}
				//*/
				
				domElements.settings = settings

                // Setup Three.js
                setupThreeJs(domElements.canvas)
                //createBuildPlate();
                //resizeRenderer();
                //animate();

                // Set up event listeners
                domElements.btn3D.addEventListener('click', () =>
                    showView('3d')
                )
                domElements.btnCode.addEventListener('click', () =>
                    showView('code')
                )
                domElements.btnEditorCode.addEventListener('click', () =>
                    showView('editor-code')
                )
                domElements.btnSettings.addEventListener('click', () =>
                    showView('settings')
                )
                domElements.btnLoad.addEventListener('click', () =>
                    openModal('load-code-modal')
                )
                // New event listener for the Clear Console button
                domElements.clearConsoleBtn.addEventListener('click', () => {
                    document.getElementById('console-panel').innerHTML = ''
                })
                // New event listener for the Clear Cache button
                document
                    .getElementById('btn-clear-cache-by-name')
                    .addEventListener('click', clearCurrentCacheByName)
                // New event listener for the Toggle Wireframe button
                document
                    .getElementById('btn-wireframe')
                    .addEventListener('click', toggleWireframe)
                // NEW: Event listener for the Help button
                domElements.btnHelp.addEventListener('click', () =>
                    showView('help')
                )

                // Corrected Save Button Logic
                domElements.btnSave.addEventListener('click', () => {
                    const { btnCode, btnEditorCode, btnSettings, btn3D } =
                        domElements
                    const activeColor = 'rgb(231, 76, 60)'

                    if (
                        btnCode.style.backgroundColor === activeColor ||
                        btnEditorCode.style.backgroundColor === activeColor
                    ) {
                        openModal('save-code-modal')
                    } else if (btn3D.style.backgroundColor === activeColor) {
                        exportSTL()
                    } else if (
                        btnSettings.style.backgroundColor === activeColor
                    ) {
                        saveSettings(domElements)
                    }
                })

                domElements.saveSettingsBtn.addEventListener('click', () =>
                    saveSettings(domElements)
                )
                domElements.clearCacheBtn.addEventListener(
                    'click',
                    clearAllCache
                )
				
				

                // ✨ MODIFIED: Initialize must run before view setup so auto-load is triggered
                initialize(domElements)

                // Initial view and render
                showView('3d')
                createBuildPlate()
                resizeRenderer()
                animate()
                // ❌ REMOVED: runCSGCode() is now handled by the autoLoadLastProject function inside initialize
            }
        </script>
    </body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Dual-Pane Test Harness with Console</title>
    <style>
        /* ... [Previous styles remain identical until body] ... */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: #f1f5f9;
            padding: 15px;
            min-height: 100vh;
        }
        /* ... [Previous styles remain identical until .container] ... */
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        /* ... [Previous styles remain identical until iframe] ... */
        iframe {
            flex: 1;
            border: none;
            width: 100%;
            min-height: 700px;
            background: #0f172a;
            border-radius: 0 0 12px 12px;
        }
        /* CONSOLE PANEL STYLES - NEW */
        .console-panel {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            margin-top: 10px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            max-height: 400px;
            transition: max-height 0.4s ease;
        }
        .console-panel.collapsed {
            max-height: 48px;
        }
        .console-header {
            padding: 12px 20px;
            background: linear-gradient(to right, #0f172a, #1e293b);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            user-select: none;
        }
        .console-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.2rem;
        }
        .console-title::before {
            content: "‚ñº";
            transition: transform 0.3s ease;
        }
        .console-panel.collapsed .console-title::before {
            transform: rotate(-90deg);
        }
        .console-count {
            background: #334155;
            color: #f1f5f9;
            border-radius: 12px;
            padding: 2px 10px;
            font-size: 0.9rem;
            min-width: 30px;
            text-align: center;
        }
        .console-count.error {
            background: #b91c1c;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .console-controls {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid #334155;
            flex-wrap: wrap;
        }
        .console-filter {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(56, 70, 89, 0.7);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .console-filter input {
            margin: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .console-clear {
            background: linear-gradient(to bottom, #b91c1c, #991b1b);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .console-clear:hover {
            background: linear-gradient(to bottom, #991b1b, #7f1d1d);
            transform: translateY(-1px);
        }
        .console-output {
            padding: 12px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.92rem;
            line-height: 1.5;
            overflow-y: auto;
            flex: 1;
            background: #0a0f1d;
            color: #e2e8f0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(56, 70, 89, 0.3);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-entry .timestamp {
            color: #64748b;
            font-size: 0.85rem;
            margin-right: 8px;
        }
        .log-entry .pane-badge {
            font-weight: bold;
            padding: 1px 6px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 0.85rem;
        }
        .pane-creator { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .pane-joiner { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .log-entry.log { color: #cbd5e1; }
        .log-entry.info { color: #38bdf8; }
        .log-entry.warn { color: #fbbf24; }
        .log-entry.error {
            color: #fca5a5;
            background: rgba(127, 29, 29, 0.15);
            border-left: 3px solid #b91c1c;
            padding-left: 8px;
            margin-left: -12px;
        }
        .log-entry.debug { color: #818cf8; opacity: 0.85; }
        .log-entry.network { color: #a78bfa; }
        .console-output::-webkit-scrollbar {
            width: 8px;
        }
        .console-output::-webkit-scrollbar-track {
            background: #0f172a;
        }
        .console-output::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        .console-output::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        /* ... [Previous responsive styles remain] ... */
        @media (max-width: 768px) {
            .console-controls { flex-direction: column; align-items: stretch; }
            .console-filter { justify-content: center; }
            iframe { min-height: 500px; }
        }
    </style>
</head>
<body>
    <h1>brtc</h1>
    
    <div class="instructions">
        <h2 style="margin-bottom:15px; display:flex; align-items:center; gap:12px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Critical Testing Instructions
        </h2>
        <div class="warning">
            ‚ö†Ô∏è <strong>Browser Permissions Required:</strong> When prompted, you MUST allow camera/microphone for BOTH iframes. 
            If blocked, click the camera/mic icon in your browser's address bar to change permissions.
        </div>
        <div class="tip">
            üí° <strong>Console Features:</strong> Real-time logs from both panes ‚Ä¢ Error highlighting ‚Ä¢ Filter by source/type ‚Ä¢ Auto-pause on errors
        </div>
        <ol>
            <li><strong>LEFT PANE (Creator):</strong> Click "‚ñ∂Ô∏è START CREATOR" button below the iframe</li>
            <li>Allow camera/microphone when prompted in the left iframe</li>
            <li><strong>RIGHT PANE (Joiner):</strong> Wait for room ID to appear below, then click "‚ñ∂Ô∏è START JOINER"</li>
            <li>Allow camera/microphone when prompted in the right iframe</li>
            <li>Test features while monitoring the console panel below for logs/errors</li>
            <li>To restart: Click "‚èπÔ∏è RESET BOTH" then repeat steps 1-4</li>
        </ol>
        <div class="tip" style="margin-top:15px;">
            üîí <strong>Security Note:</strong> All console forwarding happens locally. No data leaves your machine.
        </div>
    </div>

    <div class="status-banner">
        <h2 style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            Connection Status
        </h2>
        <div class="status-grid">
            <div class="status-card">
                <div class="status-label">Left Pane</div>
                <div class="status-value">
                    <span class="connection-status" id="status-left"></span>
                    <span id="status-text-left">Not Started</span>
                </div>
            </div>
            <div class="status-card">
                <div class="status-label">Right Pane</div>
                <div class="status-value">
                    <span class="connection-status" id="status-right"></span>
                    <span id="status-text-right">Not Started</span>
                </div>
            </div>
            <div class="status-card">
                <div class="status-label">Signaling</div>
                <div class="status-value" id="status-signaling">Waiting</div>
            </div>
            <div class="status-card">
                <div class="status-label">Room ID</div>
                <div class="status-value" id="status-room">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="iframe-grid">
            <div class="pane creator">
                <div class="pane-header">
                    <div class="pane-title">ROOM CREATOR (Offerer)</div>
                    <div style="font-size:1.1rem; opacity:0.9;">
                        <span class="connection-status" id="pane-status-left"></span>
                        <span id="pane-status-text-left">Standby</span>
                    </div>
                </div>
                <iframe id="creatorFrame" allow="camera; microphone; display-capture; autoplay; clipboard-read; clipboard-write"></iframe>
                <div class="controls">
                    <button id="startCreator" class="btn creator">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        ‚ñ∂Ô∏è START CREATOR
                    </button>
                    <button id="resetCreator" class="btn danger" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18"></path>
                            <path d="M6 6l12 12"></path>
                        </svg>
                        ‚èπÔ∏è RESET
                    </button>
                </div>
                <div class="room-id-section" id="creatorRoomSection">
                    <span class="room-id-label">AUTO-GENERATED ROOM ID:</span>
                    <div class="room-id-display" id="creatorRoomId" title="Click to copy">----------</div>
                    <div class="copy-hint">Click room ID to copy to clipboard</div>
                </div>
            </div>
            
            <div class="pane joiner">
                <div class="pane-header">
                    <div class="pane-title">ROOM JOINER (Answerer)</div>
                    <div style="font-size:1.1rem; opacity:0.9;">
                        <span class="connection-status" id="pane-status-right"></span>
                        <span id="pane-status-text-right">Standby</span>
                    </div>
                </div>
                <iframe id="joinerFrame" allow="camera; microphone; display-capture; autoplay; clipboard-read; clipboard-write"></iframe>
                <div class="controls">
                    <button id="startJoiner" class="btn joiner" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        ‚ñ∂Ô∏è START JOINER
                    </button>
                    <button id="resetJoiner" class="btn danger" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18"></path>
                            <path d="M6 6l12 12"></path>
                        </svg>
                        ‚èπÔ∏è RESET
                    </button>
                </div>
            </div>
        </div>
        
        <div style="text-align:center; padding:15px;">
            <button id="resetBoth" class="btn danger" style="min-width:220px; padding:16px; font-size:1.3rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                    <line x1="12" y1="2" x2="12" y2="12"></line>
                </svg>
                ‚èπÔ∏è RESET BOTH PANES
            </button>
        </div>

        <!-- CONSOLE PANEL - NEW -->
        <div class="console-panel" id="consolePanel">
            <div class="console-header" id="consoleToggle">
                <div class="console-title">Console Logs</div>
                <div class="console-count" id="logCount">0</div>
            </div>
            <div class="console-controls">
                <div class="console-filter">
                    <input type="checkbox" id="filterCreator" checked>
                    <label for="filterCreator">Creator Pane</label>
                </div>
                <div class="console-filter">
                    <input type="checkbox" id="filterJoiner" checked>
                    <label for="filterJoiner">Joiner Pane</label>
                </div>
                <div class="console-filter">
                    <input type="checkbox" id="filterLog" checked>
                    <label for="filterLog">Log</label>
                </div>
                <div class="console-filter">
                    <input type="checkbox" id="filterWarn" checked>
                    <label for="filterWarn">Warn</label>
                </div>
                <div class="console-filter">
                    <input type="checkbox" id="filterError" checked>
                    <label for="filterError">Error</label>
                </div>
                <div class="console-filter">
                    <input type="checkbox" id="filterDebug" checked>
                    <label for="filterDebug">Debug</label>
                </div>
                <button class="console-clear" id="clearConsole">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clear
                </button>
            </div>
            <div class="console-output" id="consoleOutput">
                <div class="log-entry info">
                    <span class="timestamp">[00:00:00.000]</span>
                    <span class="pane-badge pane-creator">SYSTEM</span>
                    Console initialized. Waiting for iframe logs...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // CONSOLE FORWARDING INJECTION SYSTEM
        // ======================
        function injectConsoleForwarding(iframe, paneName) {
            // Safety check: Ensure iframe is loaded and accessible
            try {
                if (!iframe.contentWindow || !iframe.contentWindow.document) return;
                
                // Create script element in iframe context
                const script = iframe.contentWindow.document.createElement('script');
                script.textContent = `(function(pane) {
                    // Preserve original console methods
                    const orig = {
                        log: console.log,
                        info: console.info,
                        warn: console.warn,
                        error: console.error,
                        debug: console.debug
                    };
                    
                    // Helper to format log arguments
                    const formatArgs = (args) => {
                        try {
                            return args.map(arg => {
                                if (arg instanceof Error) return arg.stack || arg.toString();
                                if (typeof arg === 'object') return JSON.stringify(arg, null, 2);
                                return String(arg);
                            }).join(' ');
                        } catch (e) {
                            return args.join(' ');
                        }
                    };
                    
                    // Override console methods
                    ['log', 'info', 'warn', 'error', 'debug'].forEach(level => {
                        console[level] = (...args) => {
                            // Call original method
                            if (orig[level]) orig[level].apply(console, args);
                            
                            // Format and send to parent
                            const msg = formatArgs(args);
                            window.parent.postMessage({
                                type: 'CONSOLE_LOG',
                                level: level,
                                message: msg,
                                pane: pane,
                                timestamp: Date.now()
                            }, '*');
                            
                            // Auto-pause on critical errors
                            if (level === 'error' && msg.toLowerCase().includes('failed')) {
                                console.warn('‚ö†Ô∏è Critical error detected - pausing execution for debugging');
                                debugger; // Triggers devtools if open
                            }
                        };
                    });
                    
                    // Global error handler
                    window.onerror = function(msg, src, line, col, error) {
                        const errorMsg = error?.stack || (msg + ' at ' + src + ':' + line + ':' + col);
                        console.error('UNHANDLED ERROR:', errorMsg);
                        window.parent.postMessage({
                            type: 'CONSOLE_LOG',
                            level: 'error',
                            message: '[UNHANDLED] ' + errorMsg,
                            pane: pane,
                            timestamp: Date.now()
                        }, '*');
                        return false; // Allow default handling
                    };
                    
                    // Unhandled promise rejections
                    window.onunhandledrejection = function(event) {
                        const reason = event.reason?.stack || event.reason?.message || String(event.reason);
                        console.error('UNHANDLED PROMISE REJECTION:', reason);
                        window.parent.postMessage({
                            type: 'CONSOLE_LOG',
                            level: 'error',
                            message: '[UNHANDLED PROMISE] ' + reason,
                            pane: pane,
                            timestamp: Date.now()
                        }, '*');
                        event.preventDefault();
                    };
                    
                    // Network request monitoring (fetch/XHR)
                    const originalFetch = window.fetch;
                    window.fetch = function(...args) {
                        const url = args[0];
                        const start = Date.now();
                        
                        return originalFetch.apply(this, args).then(response => {
                            const duration = Date.now() - start;
                            console.debug(\`[NETWORK] \${args[1]?.method || 'GET'} \${url} - \${response.status} (\${duration}ms)\`);
                            return response;
                        }).catch(error => {
                            console.error(\`[NETWORK FAIL] \${args[1]?.method || 'GET'} \${url}: \${error.message}\`);
                            throw error;
                        });
                    };
                    
                    console.log('‚úÖ Console forwarding enabled for', pane);
                })(${JSON.stringify(paneName)});`;
                
                // Inject into iframe head
                iframe.contentWindow.document.head.appendChild(script);
                console.log(`Injected console forwarding into ${paneName} iframe`);
            } catch (e) {
                console.error(`Failed to inject console forwarding for ${paneName}:`, e);
                // Fallback: send error to parent console
                window.postMessage({
                    type: 'CONSOLE_LOG',
                    level: 'error',
                    message: `Console injection failed for ${paneName}: ${e.message}`,
                    pane: 'SYSTEM',
                    timestamp: Date.now()
                }, '*');
            }
        }

        // ======================
        // DOM ELEMENTS & STATE
        // ======================
        const creatorFrame = document.getElementById('creatorFrame');
        const joinerFrame = document.getElementById('joinerFrame');
        const startCreatorBtn = document.getElementById('startCreator');
        const startJoinerBtn = document.getElementById('startJoiner');
        const resetCreatorBtn = document.getElementById('resetCreator');
        const resetJoinerBtn = document.getElementById('resetJoiner');
        const resetBothBtn = document.getElementById('resetBoth');
        const creatorRoomSection = document.getElementById('creatorRoomSection');
        const creatorRoomIdEl = document.getElementById('creatorRoomId');
        const consolePanel = document.getElementById('consolePanel');
        const consoleToggle = document.getElementById('consoleToggle');
        const consoleOutput = document.getElementById('consoleOutput');
        const logCountEl = document.getElementById('logCount');
        const clearConsoleBtn = document.getElementById('clearConsole');
        
        // Filter elements
        const filterCreator = document.getElementById('filterCreator');
        const filterJoiner = document.getElementById('filterJoiner');
        const filterLog = document.getElementById('filterLog');
        const filterWarn = document.getElementById('filterWarn');
        const filterError = document.getElementById('filterError');
        const filterDebug = document.getElementById('filterDebug');
        
        // Status elements (unchanged from original)
        const statusLeft = document.getElementById('status-left');
        const statusTextLeft = document.getElementById('status-text-left');
        const statusRight = document.getElementById('status-right');
        const statusTextRight = document.getElementById('status-text-right');
        const statusSignaling = document.getElementById('status-signaling');
        const statusRoom = document.getElementById('status-room');
        const paneStatusLeft = document.getElementById('pane-status-left');
        const paneStatusTextLeft = document.getElementById('pane-status-text-left');
        const paneStatusRight = document.getElementById('pane-status-right');
        const paneStatusTextRight = document.getElementById('pane-status-text-right');
        
        let roomId = null;
        let creatorReady = false;
        let joinerReady = false;
        let logCount = 1; // Initial welcome message
        const MAX_LOGS = 500; // Prevent memory bloat
        let errorCount = 0;

        // ======================
        // CONSOLE MANAGEMENT
        // ======================
        function formatTimestamp(timestamp) {
            const now = new Date(timestamp);
            return `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}]`;
        }

        function addLogEntry({ level, message, pane, timestamp }) {
            // Apply filters
            if (pane === 'creator' && !filterCreator.checked) return;
            if (pane === 'joiner' && !filterJoiner.checked) return;
            if (level === 'log' && !filterLog.checked) return;
            if (level === 'warn' && !filterWarn.checked) return;
            if (level === 'error' && !filterError.checked) return;
            if (level === 'debug' && !filterDebug.checked) return;
            
            // Create log entry
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.innerHTML = `
                <span class="timestamp">${formatTimestamp(timestamp)}</span>
                <span class="pane-badge pane-${pane === 'SYSTEM' ? 'creator' : pane}">${pane.toUpperCase()}</span>
                ${message.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            `;
            
            // Special handling for errors
            if (level === 'error') {
                errorCount++;
                if (errorCount >= 3) {
                    logCountEl.classList.add('error');
                }
            }
            
            // Add to console
            consoleOutput.appendChild(entry);
            
            // Auto-scroll to bottom
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Trim old logs
            if (consoleOutput.children.length > MAX_LOGS) {
                consoleOutput.removeChild(consoleOutput.firstChild);
            }
            
            // Update counter
            logCount = Math.min(logCount + 1, MAX_LOGS);
            logCountEl.textContent = errorCount > 0 ? `${logCount} (${errorCount} errors)` : logCount;
        }

        // Initialize console with system message
        addLogEntry({
            level: 'info',
            message: 'Console system initialized. Injecting log forwarders into iframes...',
            pane: 'SYSTEM',
            timestamp: Date.now()
        });

        // ======================
        // IFRAME SETUP & INJECTION
        // ======================
        function setupIframe(iframe, paneName) {
            // Inject console forwarding on load
            iframe.addEventListener('load', () => {
                setTimeout(() => {
                    try {
                        injectConsoleForwarding(iframe, paneName);
                        addLogEntry({
                            level: 'info',
                            message: `Iframe loaded and console forwarding injected: ${paneName}`,
                            pane: 'SYSTEM',
                            timestamp: Date.now()
                        });
                    } catch (e) {
                        addLogEntry({
                            level: 'error',
                            message: `Failed to inject into ${paneName}: ${e.message}`,
                            pane: 'SYSTEM',
                            timestamp: Date.now()
                        });
                    }
                }, 500); // Small delay to ensure DOM is ready
            });
            
            // Set initial src with mode parameter
            iframe.src = `/webrtc-test.html?mode=${paneName}`;
        }

        // Initialize both iframes
        setupIframe(creatorFrame, 'creator');
        setupIframe(joinerFrame, 'joiner');

        // ======================
        // MESSAGE HANDLING
        // ======================
        window.addEventListener('message', (event) => {
            // Security: Only accept messages from our origin
            if (event.origin !== window.location.origin) return;
            
            const { type, data } = event.data;
            
            // Handle console logs from iframes
            if (type === 'CONSOLE_LOG') {
                addLogEntry(data);
                return;
            }
            
            // Handle original signaling messages
            switch (type) {
                case 'ROOM_CREATED':
                    roomId = data.roomId;
                    creatorRoomIdEl.textContent = roomId;
                    creatorRoomSection.style.display = 'block';
                    statusRoom.textContent = roomId;
                    statusSignaling.textContent = 'Room Active';
                    statusSignaling.parentElement.className = 'status-card success';
                    
                    // Enable joiner button
                    startJoinerBtn.disabled = false;
                    startJoinerBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        ‚ñ∂Ô∏è JOIN ROOM: ${roomId.substring(0,6)}...
                    `;
                    
                    // Update URL
                    const url = new URL(window.location);
                    url.searchParams.set('room', roomId);
                    history.replaceState({}, '', url);
                    
                    // Copy functionality
                    creatorRoomIdEl.onclick = () => {
                        navigator.clipboard.writeText(roomId).then(() => {
                            creatorRoomIdEl.classList.add('copied');
                            setTimeout(() => creatorRoomIdEl.classList.remove('copied'), 1500);
                            addLogEntry({
                                level: 'info',
                                message: `Room ID copied to clipboard: ${roomId}`,
                                pane: 'SYSTEM',
                                timestamp: Date.now()
                            });
                        }).catch(err => {
                            addLogEntry({
                                level: 'warn',
                                message: `Failed to copy room ID: ${err.message}`,
                                pane: 'SYSTEM',
                                timestamp: Date.now()
                            });
                        });
                    };
                    
                    updateStatus({ 
                        querySelector: sel => document.querySelector(sel),
                        className: ''
                    }, 'connected', 'Room Created');
                    paneStatusTextLeft.textContent = 'Room Created';
                    paneStatusLeft.className = 'connection-status connected';
                    creatorReady = true;
                    
                    addLogEntry({
                        level: 'info',
                        message: `Room created successfully: ${roomId}`,
                        pane: 'creator',
                        timestamp: Date.now()
                    });
                    break;
                    
                case 'JOINED_ROOM':
                    updateStatus({ 
                        querySelector: sel => document.querySelector(sel),
                        className: ''
                    }, 'connected', 'Connected');
                    paneStatusTextRight.textContent = 'Connected';
                    paneStatusRight.className = 'connection-status connected';
                    joinerReady = true;
                    
                    addLogEntry({
                        level: 'info',
                        message: `Successfully joined room: ${roomId}`,
                        pane: 'joiner',
                        timestamp: Date.now()
                    });
                    break;
                    
                case 'CONNECTION_STATE':
                    const target = data.pane === 'creator' ? 'left' : 'right';
                    const statusEl = document.getElementById(`status-${target}`);
                    const textEl = document.getElementById(`status-text-${target}`);
                    
                    statusEl.className = 'connection-status';
                    if (data.state === 'connected') {
                        statusEl.classList.add('connected');
                        textEl.textContent = 'Connected';
                    } else if (data.state === 'connecting') {
                        statusEl.classList.add('connecting');
                        textEl.textContent = 'Connecting...';
                    } else if (data.state === 'failed' || data.state === 'disconnected') {
                        statusEl.classList.add('danger');
                        textEl.textContent = 'Disconnected';
                    } else {
                        textEl.textContent = data.state.charAt(0).toUpperCase() + data.state.slice(1);
                    }
                    
                    addLogEntry({
                        level: data.state === 'failed' ? 'error' : 'debug',
                        message: `Connection state (${data.pane}): ${data.state}`,
                        pane: data.pane,
                        timestamp: Date.now()
                    });
                    break;
                    
                case 'STREAM_RECEIVED':
                    if (data.pane === 'joiner') {
                        paneStatusTextLeft.textContent = 'Peer Connected';
                        paneStatusLeft.className = 'connection-status connected';
                    } else {
                        paneStatusTextRight.textContent = 'Peer Connected';
                        paneStatusRight.className = 'connection-status connected';
                    }
                    
                    addLogEntry({
                        level: 'info',
                        message: `Remote stream received in ${data.pane} pane`,
                        pane: data.pane,
                        timestamp: Date.now()
                    });
                    break;
            }
        });

        // ======================
        // STATUS UPDATE HELPER
        // ======================
        function updateStatus(element, state, text) {
            const statusEl = element.querySelector('.connection-status');
            const textEl = element.querySelector('span:last-child');
            
            statusEl.className = 'connection-status';
            if (state === 'connected') {
                statusEl.classList.add('connected');
                element.className = 'status-card success';
            } else if (state === 'connecting') {
                statusEl.classList.add('connecting');
                element.className = 'status-card';
            } else if (state === 'failed') {
                statusEl.classList.add('danger');
                element.className = 'status-card danger';
            } else {
                element.className = 'status-card';
            }
            
            if (textEl) textEl.textContent = text || 'Unknown';
        }

        // ======================
        // BUTTON HANDLERS
        // ======================
        startCreatorBtn.addEventListener('click', () => {
            creatorFrame.contentWindow.postMessage({ type: 'START_CREATOR' }, '*');
            startCreatorBtn.disabled = true;
            resetCreatorBtn.disabled = false;
            updateStatus({ 
                querySelector: sel => document.querySelector(sel),
                className: ''
            }, 'connecting', 'Creating Room...');
            paneStatusTextLeft.textContent = 'Creating Room...';
            paneStatusLeft.className = 'connection-status connecting';
            
            addLogEntry({
                level: 'info',
                message: 'START_CREATOR command sent to creator iframe',
                pane: 'SYSTEM',
                timestamp: Date.now()
            });
        });
        
        startJoinerBtn.addEventListener('click', () => {
            if (!roomId) {
                const msg = 'Wait for room ID to appear in left pane first!';
                alert(msg);
                addLogEntry({
                    level: 'warn',
                    message: msg,
                    pane: 'SYSTEM',
                    timestamp: Date.now()
                });
                return;
            }
            joinerFrame.contentWindow.postMessage({ type: 'JOIN_ROOM', roomId }, '*');
            startJoinerBtn.disabled = true;
            resetJoinerBtn.disabled = false;
            updateStatus({ 
                querySelector: sel => document.querySelector(sel.replace('left', 'right')),
                className: ''
            }, 'connecting', 'Joining Room...');
            paneStatusTextRight.textContent = 'Joining Room...';
            paneStatusRight.className = 'connection-status connecting';
            
            addLogEntry({
                level: 'info',
                message: `JOIN_ROOM command sent to joiner iframe with room ID: ${roomId}`,
                pane: 'SYSTEM',
                timestamp: Date.now()
            });
        });
        
        resetCreatorBtn.addEventListener('click', () => {
            creatorFrame.contentWindow.postMessage({ type: 'RESET' }, '*');
            resetCreatorBtn.disabled = true;
            startCreatorBtn.disabled = false;
            creatorRoomSection.style.display = 'none';
            roomId = null;
            startJoinerBtn.disabled = true;
            startJoinerBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                ‚ñ∂Ô∏è START JOINER
            `;
            statusRoom.textContent = '-';
            statusSignaling.textContent = 'Waiting';
            statusSignaling.parentElement.className = 'status-card';
            creatorReady = false;
            paneStatusTextLeft.textContent = 'Reset';
            paneStatusLeft.className = 'connection-status';
            
            addLogEntry({
                level: 'info',
                message: 'Creator pane reset initiated',
                pane: 'SYSTEM',
                timestamp: Date.now()
            });
        });
        
        resetJoinerBtn.addEventListener('click', () => {
            joinerFrame.contentWindow.postMessage({ type: 'RESET' }, '*');
            resetJoinerBtn.disabled = true;
            startJoinerBtn.disabled = !creatorReady;
            joinerReady = false;
            paneStatusTextRight.textContent = 'Reset';
            paneStatusRight.className = 'connection-status';
            
            addLogEntry({
                level: 'info',
                message: 'Joiner pane reset initiated',
                pane: 'SYSTEM',
                timestamp: Date.now()
            });
        });
        
        resetBothBtn.addEventListener('click', () => {
            if (creatorReady || joinerReady) {
                if (!confirm('Reset both panes? Current connection will be terminated.')) return;
            }
            resetCreatorBtn.click();
            resetJoinerBtn.click();
            addLogEntry({
                level: 'info',
                message: 'Both panes reset by user',
                pane: 'SYSTEM',
                timestamp: Date.now()
            });
        });
        
        // Console panel toggle
        consoleToggle.addEventListener('click', () => {
            consolePanel.classList.toggle('collapsed');
            // Save preference to localStorage
            localStorage.setItem('consoleCollapsed', consolePanel.classList.contains('collapsed'));
        });
        
        // Restore console state
        if (localStorage.getItem('consoleCollapsed') === 'true') {
            consolePanel.classList.add('collapsed');
        }
        
        // Clear console
        clearConsoleBtn.addEventListener('click', () => {
            consoleOutput.innerHTML = '';
            logCount = 0;
            errorCount = 0;
            logCountEl.textContent = '0';
            logCountEl.classList.remove('error');
            addLogEntry({
                level: 'info',
                message: 'Console cleared by user',
                pane: 'SYSTEM',
                timestamp: Date.now()
            });
        });
        
        // Filter change handlers
        [filterCreator, filterJoiner, filterLog, filterWarn, filterError, filterDebug].forEach(filter => {
            filter.addEventListener('change', () => {
                // Re-render visible logs (simple approach: clear and re-add all stored logs)
                // For production: store log history array and re-render filtered view
                consoleOutput.innerHTML = '';
                logCount = 0;
                errorCount = 0;
                logCountEl.textContent = '0';
                logCountEl.classList.remove('error');
                // Add welcome message back
                addLogEntry({
                    level: 'info',
                    message: 'Console filters updated. New logs will appear below...',
                    pane: 'SYSTEM',
                    timestamp: Date.now()
                });
            });
        });
        
        // Handle URL parameters
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                roomId = roomParam;
                creatorRoomIdEl.textContent = roomId;
                creatorRoomSection.style.display = 'block';
                statusRoom.textContent = roomId;
                statusSignaling.textContent = 'Room Active';
                statusSignaling.parentElement.className = 'status-card success';
                startJoinerBtn.disabled = false;
                startJoinerBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    ‚ñ∂Ô∏è JOIN ROOM: ${roomId.substring(0,6)}...
                `;
                addLogEntry({
                    level: 'info',
                    message: `Room ID loaded from URL parameter: ${roomId}`,
                    pane: 'SYSTEM',
                    timestamp: Date.now()
                });
            }
        });
        
        // Auto-focus creator button
        setTimeout(() => {
            startCreatorBtn.focus();
            addLogEntry({
                level: 'debug',
                message: 'Test harness fully initialized. Ready for user interaction.',
                pane: 'SYSTEM',
                timestamp: Date.now()
            });
        }, 500);
    </script>
</body>
</html>